<?xml version="1.0" encoding="UTF-8"?>
<!--
  Licensed to the Apache Software Foundation (ASF) under one or more
  contributor license agreements.  See the NOTICE file distributed with
  this work for additional information regarding copyright ownership.
  The ASF licenses this file to You under the Apache License, Version 2.0
  (the "License"); you may not use this file except in compliance with
  the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<tdml:testSuite xmlns:tdml="http://www.ibm.com/xmlns/dfdl/testData"
                xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                xmlns:dfdl="http://www.ogf.org/dfdl/dfdl-1.0/" xmlns:xs="http://www.w3.org/2001/XMLSchema"
                xmlns:fn="http://www.w3.org/2005/xpath-functions"
                xmlns:daf="urn:ogf:dfdl:2013:imp:daffodil.apache.org:2018:ext"
                xmlns:dfdlx="http://www.ogf.org/dfdl/dfdl-1.0/extensions"
                xmlns:ex="http://example.com" xmlns:tns="http://example.com" defaultRoundTrip="onePass">

  <tdml:defineSchema name="s1" elementFormDefault="unqualified">
    <xs:include schemaLocation="org/apache/daffodil/xsd/DFDLGeneralFormat.dfdl.xsd"/>
    <dfdl:defineFormat name="general">
      <dfdl:format ref="ex:GeneralFormat"/>
    </dfdl:defineFormat>
    <dfdl:defineFormat name="zip">
      <dfdl:format ref="ex:general"
                   dfdlx:layerTransform="zip"
                   dfdlx:layerLengthKind="explicit"
                   dfdlx:layerLengthUnits="bytes"/>
    </dfdl:defineFormat>
    <dfdl:format ref="ex:general" representation="binary" byteOrder="bigEndian"
                 alignment="1" alignmentUnits="bytes" lengthUnits="bytes" encoding="UTF-16BE"/>

    <xs:element name="zipFile">
      <xs:complexType>
        <xs:sequence>
          <xs:element name="zipLength" type="xs:long" dfdl:lengthKind="implicit"
                      dfdl:outputValueCalc='{ dfdl:contentLength(../zip, "bytes") }'/>
          <xs:element name="zip" type="tns:zipType"/>
        </xs:sequence>
      </xs:complexType>
    </xs:element>

    <xs:complexType name="zipType">
      <xs:sequence dfdl:ref="tns:zip" dfdlx:layerLength="{ ../zipLength }">
        <xs:element name="zipEntries">
          <xs:complexType>
            <xs:sequence>
              <xs:element name="zipEntry" maxOccurs="unbounded" dfdl:occursCountKind="implicit">
                <xs:complexType>
                  <xs:sequence>
                    <xs:element name="nameLen" type="xs:unsignedInt" dfdl:lengthKind="explicit" dfdl:length="4"
                                dfdl:outputValueCalc='{ dfdl:valueLength(../name, "bytes") }'/>
                    <xs:element name="commentLen" type="xs:unsignedInt" dfdl:lengthKind="explicit" dfdl:length="4"
                                dfdl:outputValueCalc='{ dfdl:valueLength(../comment, "bytes") }'/>
                    <xs:element name="extraLen" type="xs:unsignedInt" dfdl:lengthKind="explicit" dfdl:length="4"
                                dfdl:outputValueCalc='{ dfdl:valueLength(../extra, "bytes") }'/>
                    <xs:element name="method" type="xs:unsignedInt" dfdl:lengthKind="explicit" dfdl:length="4"/>
                    <xs:element name="time" type="xs:long" dfdl:lengthKind="explicit" dfdl:length="8"/>
                    <xs:element name="isDirectory" type="xs:boolean" dfdl:lengthKind="explicit" dfdl:length="1"
                                dfdl:binaryBooleanTrueRep="1" dfdl:binaryBooleanFalseRep="0"
                                dfdl:outputValueCalc='{ fn:ends-with(../name, "/") }'/>
                    <xs:element name="dataLen" type="xs:unsignedLong" dfdl:lengthKind="explicit" dfdl:length="8"
                                dfdl:outputValueCalc='{ dfdl:valueLength(../data, "bytes") }'/>
                    <xs:element name="name" type="xs:string" dfdl:lengthKind="explicit"
                                dfdl:length="{ ../nameLen }"/>
                    <xs:element name="comment" type="xs:string" dfdl:lengthKind="explicit"
                                dfdl:length="{ ../commentLen }"/>
                    <xs:element name="extra" type="xs:hexBinary" dfdl:lengthKind="explicit"
                                dfdl:length="{ ../extraLen }"/>
                    <xs:element name="data" type="xs:hexBinary" dfdl:lengthKind="explicit"
                                dfdl:length="{ ../dataLen }"/>
                  </xs:sequence>
                </xs:complexType>
              </xs:element>
            </xs:sequence>
          </xs:complexType>
        </xs:element>
      </xs:sequence>
    </xs:complexType>

  </tdml:defineSchema>

  <tdml:unparserTestCase name="zipLayer1u" model="s1" roundTrip="onePass">
    <tdml:document>
      <!--
      <tdml:documentPart type="byte"><![CDATA[
00 00 00 00 00 00 00 A4
50 4b 03 04 0a 03 00 00 00 00 46 71 36 52 b5 37
3c 98 10 00 00 00 10 00 00 00 07 00 00 00 66 6f
6f 2e 74 78 74 30 31 32 33 34 35 36 37 38 39 41
42 43 44 45 46 50 4b 01 02 3f 03 0a 03 00 00 00
00 46 71 36 52 b5 37 3c 98 10 00 00 00 10 00 00
00 07 00 24 00 00 00 00 00 00 00 20 80 b4 81 00
00 00 00 66 6f 6f 2e 74 78 74 0a 00 20 00 00 00
00 00 01 00 18 00 00 c2 3d 35 f2 f0 d6 01 80 39
cc 3b f2 f0 d6 01 00 c2 3d 35 f2 f0 d6 01 50 4b
05 06 00 00 00 00 01 00 01 00 59 00 00 00 35 00
00 00 00 00                                     ]]>
      </tdml:documentPart>
-->
        <tdml:documentPart type="byte"><![CDATA[
0000000000000094
50 4B 03 04 0A 00 00 08 00 00 00 21 00 00 B5 37
3C 98 10 00 00 00 10 00 00 00 07 00 14 00 66 6F
6F2E7478740100100010000000000000
00100000000000000030313233343536
373839414243444546504B010214000A
000008000000210000B5373C98100000
00100000000700000000000000000000
00000000000000666F6F2E747874504B
05060000000001000100350000004900
00000000
          ]]>
        </tdml:documentPart>
    </tdml:document>
    <tdml:infoset>
      <tdml:dfdlInfoset>
        <ex:zipFile xmlns:ex="http://example.com">
          <zipLength>148</zipLength>
          <zip>
            <zipEntries>
              <zipEntry>
                <nameLen>14</nameLen>
                <commentLen>0</commentLen>
                <extraLen>0</extraLen>
                <method>0</method>
                <time>0</time>
                <isDirectory>false</isDirectory>
                <dataLen>16</dataLen>
                <name>foo.txt</name>
                <comment></comment>
                <extra></extra>
                <data>30313233343536373839414243444546</data>
              </zipEntry>
            </zipEntries>
          </zip>
        </ex:zipFile>
      </tdml:dfdlInfoset>
    </tdml:infoset>
  </tdml:unparserTestCase>

  <tdml:parserTestCase name="zipLayer1p" model="s1" roundTrip="onePass">
    <tdml:document>
      <!--
      <tdml:documentPart type="byte"><![CDATA[
00 00 00 00 00 00 00 A4
50 4b 03 04 0a 03 00 00 00 00 46 71 36 52 b5 37
3c 98 10 00 00 00 10 00 00 00 07 00 00 00 66 6f
6f 2e 74 78 74 30 31 32 33 34 35 36 37 38 39 41
42 43 44 45 46 50 4b 01 02 3f 03 0a 03 00 00 00
00 46 71 36 52 b5 37 3c 98 10 00 00 00 10 00 00
00 07 00 24 00 00 00 00 00 00 00 20 80 b4 81 00
00 00 00 66 6f 6f 2e 74 78 74 0a 00 20 00 00 00
00 00 01 00 18 00 00 c2 3d 35 f2 f0 d6 01 80 39
cc 3b f2 f0 d6 01 00 c2 3d 35 f2 f0 d6 01 50 4b
05 06 00 00 00 00 01 00 01 00 59 00 00 00 35 00
00 00 00 00                                     ]]>
      </tdml:documentPart>
      -->
      <tdml:documentPart type="byte"><![CDATA[
0000000000000094
50 4B 03 04 0A 00 00 08 00 00 00 21 00 00 B5 37
3C 98 10 00 00 00 10 00 00 00 07 00 14 00 66 6F
6F2E7478740100100010000000000000
00100000000000000030313233343536
373839414243444546504B010214000A
000008000000210000B5373C98100000
00100000000700000000000000000000
00000000000000666F6F2E747874504B
05060000000001000100350000004900
00000000
          ]]>
      </tdml:documentPart>
    </tdml:document>
    <tdml:infoset>
      <tdml:dfdlInfoset>
        <ex:zipFile xmlns:ex="http://example.com">
          <zipLength>148</zipLength>
          <zip>
            <zipEntries>
              <zipEntry>
                <nameLen>14</nameLen>
                <commentLen>0</commentLen>
                <extraLen>0</extraLen>
                <method>0</method>
                <time>0</time>
                <isDirectory>false</isDirectory>
                <dataLen>16</dataLen>
                <name>foo.txt</name>
                <comment></comment>
                <extra></extra>
                <data>30313233343536373839414243444546</data>
              </zipEntry>
            </zipEntries>
          </zip>
        </ex:zipFile>
      </tdml:dfdlInfoset>
    </tdml:infoset>
  </tdml:parserTestCase>

</tdml:testSuite>
